<!-- public/fichaje-rapido.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fichaje Rápido</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <h1>Fichaje para <span id="nombreEmpleado" style="color: var(--primary-color);">...</span></h1>
        
        <div class="fichaje-section" style="margin-top: 2rem;">
            <!-- CÓDIGO A MODIFICAR en fichaje-rapido.html -->
<div class="fichaje-actions">
    <div class="action-button-wrapper">
        <button id="btnEntrada" class="action-button primary entrada" onclick="iniciarFichaje('entrada')" disabled>
            <i class="bi bi-plus-lg"></i>
        </button>
        <span class="action-label">Entrada</span>
    </div>
    <div class="action-button-wrapper">
        <button id="btnSalida" class="action-button primary salida" onclick="iniciarFichaje('salida')" disabled>
            <i class="bi bi-dash-lg"></i>
        </button>
        <span class="action-label">Salida</span>
    </div>
</div>
        </div>

        <button id="btnNoSoyYo" class="btn-secundario" style="margin-top: 30px;">No soy yo, volver</button>
    </div>

    <!-- El modal de la cámara y el canvas (copiado de panel.html) -->
    <div id="cameraModal" class="modal"><div class="modal-content"><h2>Sonríe para la foto</h2><video id="video" autoplay playsinline></video><p>Tomando foto en 3 segundos...</p></div></div>
    <canvas id="canvas" style="display:none;"></canvas>


// REEMPLAZA TU SCRIPT ACTUAL CON ESTE CÓDIGO COMPLETO Y DEFINITIVO
<script>
    const nombreEmpleadoSpan = document.getElementById('nombreEmpleado');
    const [btnEntrada, btnSalida] = [document.getElementById('btnEntrada'), document.getElementById('btnSalida')];
    const [cameraModal, video, canvas] = [document.getElementById('cameraModal'), document.getElementById('video'), document.getElementById('canvas')];
    let stream;
    let userId;

    function actualizarBotones(estado) {
        if (estado === 'entrada') {
            btnEntrada.disabled = true;
            btnSalida.disabled = false;
        } else {
            btnEntrada.disabled = false;
            btnSalida.disabled = true;
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        userId = params.get('id');
        const nombre = params.get('nombre');

        if (!userId || userId === 'null' || !nombre) {
            Swal.fire({
                icon: 'error', title: 'Error de Carga',
                text: 'No se pudo obtener la información del empleado.',
                confirmButtonText: 'Volver'
            }).then(() => { window.location.href = '/index.html'; });
            return;
        }
        
        nombreEmpleadoSpan.textContent = nombre;

        try {
            // --- LA SOLUCIÓN: CONSTRUIR UNA URL ABSOLUTA ---
            // Esto obtiene "https://tu-dominio.railway.app" o "http://localhost:3000"
            const origin = window.location.origin; 
            const apiUrl = `${origin}/api/estado-empleado/${encodeURIComponent(userId)}`;
            // -------------------------------------------------------------------
            
            console.log('Llamando a la API con URL absoluta:', apiUrl); // Nuevo log para confirmar
            
            const res = await fetch(apiUrl);

            if (!res.ok) {
                 const errorText = await res.text(); // Obtener texto plano para depurar
                 console.error("Error del servidor:", res.status, errorText);
                 throw new Error('El servidor respondió con un error.');
            }
            const data = await res.json();
            actualizarBotones(data.estado);
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo verificar el estado del empleado. Inténtalo de nuevo.', 'error');
        }
    });

    document.getElementById('btnNoSoyYo').addEventListener('click', () => {
        window.location.href = '/index.html';
    });

    // Las demás funciones (iniciarFichaje, tomarFotoYFichar, enviarFichaje) no cambian.
    async function iniciarFichaje(tipo) {
        cameraModal.style.display = 'flex';
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            setTimeout(() => tomarFotoYFichar(tipo), 3000);
        } catch (err) {
            Swal.fire('Error', 'No se pudo acceder a la cámara. Asegúrate de dar permisos.', 'error');
            cameraModal.style.display = 'none';
        }
    }

    function tomarFotoYFichar(tipo) {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        cameraModal.style.display = 'none';
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('tipo', tipo);
            formData.append('foto', blob, 'fichaje.jpeg');
            formData.append('usuarioId', userId);
            enviarFichaje(formData);
        }, 'image/jpeg');
    }

    async function enviarFichaje(formData) {
        const origin = window.location.origin;
        try {
            const res = await fetch(`${origin}/api/fichar-rapido`, { // Usamos URL absoluta aquí también
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);

            Swal.fire({
                icon: 'success', title: '¡Fichaje Correcto!',
                text: data.message, timer: 2500,
                showConfirmButton: false,
                willClose: () => { window.location.href = '/index.html'; }
            });
        } catch (error) {
            Swal.fire({
                icon: 'error', title: 'Error en el Fichaje',
                text: error.message || 'Hubo un problema al registrar el fichaje.'
            }).then(() => { window.location.href = '/index.html'; });
        }
    }
</script>
</body>
</html>