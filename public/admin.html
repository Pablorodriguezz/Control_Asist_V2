<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administrador</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
</head>
<body>
    <div class="container">
        <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
        <h1>Panel de Administración</h1>

        <section>
            <h2>Informe de Asistencia Diario</h2>
            <input type="date" id="fecha" onchange="getReport()" />
            <div class="table-container">
                <table id="reportTable">
                    <thead><tr><th>Nombre</th><th>Fecha y Hora</th><th>Tipo</th><th>Foto</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <hr />

        <section>
            <h2>Informe Mensual por Trabajador</h2>
            <div>
                <select id="selectUsuario" required>
                    <option value="">-- Selecciona un trabajador --</option>
                </select>
                <input type="month" id="selectMes" required />
                <button onclick="generarInformeMensual()">Generar Informe</button>
                <button id="btnExportar" style="display: none" onclick="exportarCSV()">Exportar a CSV</button>
            </div>
            <div id="informeMensualContainer" style="margin-top: 20px;"></div>
        </section>
        <hr />

        <section>
            <h2>Gestión de Usuarios</h2>
            <div class="table-container">
                <table id="usersTable">
                    <thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <hr />

        <section>
            <h2>Crear Nuevo Usuario</h2>
            <form id="createUserForm">
                <input type="text" id="nombre" placeholder="Nombre completo" required />
                <input type="text" id="usuario" placeholder="Nombre de usuario (login)" required />
                <input type="password" id="password" placeholder="Contraseña" required />
                <select id="rol" required>
                    <option value="empleado" selected>Empleado</option>
                    <option value="admin">Administrador</option>
                </select>
                <button type="submit" class="btn-create">Crear Usuario</button>
            </form>
        </section>
        <hr />
        
        <section>
            <h2>Crear Fichaje Manual</h2>
            <form id="manualAttendanceForm">
                <label for="manualUsuario">Trabajador:</label>
                <select id="manualUsuario" required>
                    <option value="">-- Selecciona un trabajador --</option>
                </select>
                <label for="manualFechaHora">Fecha y Hora del Fichaje:</label>
                <input type="datetime-local" id="manualFechaHora" required />
                <label for="manualTipo">Tipo de Fichaje:</label>
                <select id="manualTipo" required>
                    <option value="" disabled selected>-- Selecciona tipo --</option>
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                </select>
                <label for="manualMotivo">Motivo (ej: olvido, error del sistema):</label>
                <textarea id="manualMotivo" placeholder="Es obligatorio explicar por qué se crea este fichaje." required></textarea>
                <button type="submit">Crear Fichaje Manual</button>
            </form>
        </section>
        <hr />

        <section>
            <h2>Gestión de Vacaciones</h2>
            <form id="formVacaciones">
                <label for="vacacionesUsuario">Trabajador:</label>
                <select id="vacacionesUsuario" required>
                    <option value="">-- Selecciona un trabajador --</option>
                </select>
                <span id="infoDiasRestantes" style="display: block; margin-bottom: 15px; font-weight: bold;"></span>
                
                <label for="fechaInicio">Fecha de Inicio:</label>
                <input type="date" id="fechaInicio" required>
                
                <label for="fechaFin">Fecha de Fin:</label>
                <input type="date" id="fechaFin" required>
                
                <button type="submit">Asignar Vacaciones</button>
            </form>
            <hr style="margin: 20px 0;">
            <div id="calendarioVacaciones"></div>
        </section>
    </div>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "/index.html";
        const selectUsuario = document.getElementById('selectUsuario');
        const selectMes = document.getElementById('selectMes');
        const btnExportar = document.getElementById('btnExportar');
        let calendario;
        
        function logout() {
            localStorage.removeItem("token");
            window.location.href = "/index.html";
        }

        // ... (Todas las funciones de getReport, abrirModalEdicion, eliminarRegistro, etc. se quedan igual) ...
        async function getReport() {
            const fecha = document.getElementById("fecha").value;
            if (!fecha) return;
            try {
                const res = await fetch(`/api/informe?fecha=${fecha}`, { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) throw new Error('Error al cargar informe diario');
                const data = await res.json();
                const tbody = document.querySelector("#reportTable tbody");
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No hay registros para esta fecha.</td></tr>';
                } else {
                    data.forEach(row => {
                        const tr = document.createElement("tr");
                        const fechaHora = new Date(row.fecha_hora).toLocaleString("es-ES", { dateStyle: "short", timeStyle: "medium" });
                        const fotoHtml = row.foto_path ? `<a href="${row.foto_path}" target="_blank"><img src="${row.foto_path}" alt="Foto fichaje" class="photo-thumbnail"></a>` : "Sin foto";
                        let indicadorEditado = '';
                        if (row.es_modificado) {
                            const fechaOriginal = row.fecha_hora_original ? new Date(row.fecha_hora_original).toLocaleString("es-ES") : 'N/A';
                            const motivo = row.motivo_modificacion ? row.motivo_modificacion.replace(/"/g, '"') : 'N/A';
                            const title = row.fecha_hora_original ? `Editado. Original: ${fechaOriginal}. Motivo: ${motivo}` : `Registro manual. Motivo: ${motivo}`;
                            indicadorEditado = `<span title="${title}" style="cursor: help; color: #f39c12; font-weight: bold;"> ✏️</span>`;
                        }
                        tr.innerHTML = `<td>${row.nombre}</td><td>${fechaHora}${indicadorEditado}</td><td>${row.tipo}</td><td>${fotoHtml}</td><td><button class="action-btn btn-reset" onclick="abrirModalEdicion(${row.id}, '${row.fecha_hora}', '${row.nombre}')">Editar</button><button class="action-btn btn-delete" onclick="eliminarRegistro(${row.id}, '${row.nombre}', '${fechaHora}')">Eliminar</button></td>`;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) { document.querySelector("#reportTable tbody").innerHTML = '<tr><td colspan="5">Error al cargar datos.</td></tr>'; }
        }

        async function abrirModalEdicion(registroId, fechaHoraActual, nombreUsuario) {
            const fechaParaInput = new Date(fechaHoraActual).toISOString().slice(0, 16);
            const { value: formValues } = await Swal.fire({
                title: `Editar fichaje de ${nombreUsuario}`,
                html: `<p style="margin-bottom: 1rem;">Fecha y Hora Actual: ${new Date(fechaHoraActual).toLocaleString()}</p><label for="swal-input-fecha">Nueva Fecha y Hora:</label><input id="swal-input-fecha" type="datetime-local" value="${fechaParaInput}" class="swal2-input" style="width: auto; margin-top: 0.5rem;"><textarea id="swal-input-motivo" class="swal2-textarea" placeholder="Motivo de la edición (obligatorio)" style="margin-top: 1rem;"></textarea>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'Guardar Cambios', cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nuevaFechaHora = document.getElementById('swal-input-fecha').value;
                    const motivo = document.getElementById('swal-input-motivo').value.trim();
                    if (!nuevaFechaHora || !motivo) { Swal.showValidationMessage('Por favor, completa la nueva fecha/hora y el motivo.'); return false; }
                    return { nuevaFechaHora, motivo };
                }
            });
            if (formValues) {
                try {
                    const res = await fetch(`/api/registros/${registroId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(formValues) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¡Actualizado!', 'El registro ha sido modificado con éxito.', 'success');
                    getReport();
                } catch (error) { Swal.fire('Error', `No se pudo actualizar: ${error.message}`, 'error'); }
            }
        }

        async function eliminarRegistro(registroId, nombreUsuario, fechaHoraFormateada) {
            Swal.fire({
                title: `¿Estás seguro?`, html: `Se eliminará permanentemente el fichaje de <strong>${nombreUsuario}</strong> de la fecha <strong>${fechaHoraFormateada}</strong>. <br><br><strong>¡Esta acción no se puede revertir!</strong>`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí, ¡eliminar!', cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`/api/registros/${registroId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.message);
                        Swal.fire('¡Eliminado!', 'El registro ha sido eliminado.', 'success');
                        getReport();
                    } catch (error) { Swal.fire('Error', `No se pudo eliminar: ${error.message}`, 'error'); }
                }
            });
        }

        async function loadUsers() {
            try {
                const res = await fetch("/api/usuarios", { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) throw new Error("No se pudo cargar la lista de usuarios.");
                const users = await res.json();
                const tbody = document.querySelector("#usersTable tbody");
                tbody.innerHTML = "";
                users.forEach(user => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${user.nombre}</td><td>${user.usuario}</td><td>${user.rol}</td><td><button class="action-btn btn-reset" onclick="resetPassword(${user.id}, '${user.nombre}')">Resetear</button><button class="action-btn btn-delete" onclick="deleteUser(${user.id}, '${user.nombre}')">Eliminar</button></td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) { console.error("Error en loadUsers:", error); }
        }

        async function resetPassword(userId, userName) {
            const { value: newPassword } = await Swal.fire({
                title: `Nueva contraseña para ${userName}`, input: 'password', inputLabel: 'Contraseña', inputPlaceholder: 'Introduce la nueva contraseña',
                showCancelButton: true, confirmButtonText: 'Restablecer', cancelButtonText: 'Cancelar',
                inputValidator: (value) => !value && '¡Necesitas escribir una contraseña!'
            });
            if (newPassword) {
                try {
                    const res = await fetch(`/api/usuarios/${userId}/password`, { method: "PUT", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify({ password: newPassword }) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¡Éxito!', data.message, 'success');
                } catch (error) { Swal.fire('Error', error.message, 'error'); }
            }
        }

        async function deleteUser(userId, userName) {
            Swal.fire({
                title: `¿Estás seguro de eliminar a ${userName}?`, text: "¡Esta acción no se puede revertir!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí, ¡eliminar!', cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`/api/usuarios/${userId}`, { method: "DELETE", headers: { Authorization: `Bearer ${token}` } });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.message);
                        Swal.fire('¡Eliminado!', 'El usuario ha sido eliminado.', 'success');
                        loadUsers();
                        poblarSelectorUsuarios('selectUsuario');
                        poblarSelectorUsuarios('manualUsuario');
                        poblarSelectorUsuarios('vacacionesUsuario');
                    } catch (error) { Swal.fire('Error', error.message, 'error'); }
                }
            });
        }

        async function poblarSelectorUsuarios(selectorId) {
            const selectElement = document.getElementById(selectorId);
            try {
                const res = await fetch('/api/usuarios', { headers: { 'Authorization': `Bearer ${token}` } });
                const usuarios = await res.json();
                const defaultOptionHTML = selectElement.querySelector('option[value=""]').outerHTML;
                selectElement.innerHTML = defaultOptionHTML;
                usuarios.forEach(user => {
                    if (user.rol === 'empleado') {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.nombre;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) { console.error(`Error en poblarSelectorUsuarios para #${selectorId}:`, error); }
        }

        // ... (informe mensual y exportar csv se quedan igual) ...

        // ==================================================
        // LÓGICA PARA GESTIÓN DE VACACIONES
        // ==================================================
        function inicializarCalendario() {
            const calendarioEl = document.getElementById('calendarioVacaciones');
            calendario = new FullCalendar.Calendar(calendarioEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                eventClick: function(info) {
                    handleEventClick(info.event);
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    fetch('/api/vacaciones', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    })
                    .then(res => res.ok ? res.json() : Promise.reject('Respuesta no válida del servidor'))
                    .then(data => {
                        const dataProcesada = data.map(evento => {
                            let solapado = false;
                            const inicioEvento = new Date(evento.fecha_inicio);
                            const finEvento = new Date(evento.fecha_fin);
                            for (const otroEvento of data) {
                                if (evento.id === otroEvento.id) continue;
                                const inicioOtro = new Date(otroEvento.fecha_inicio);
                                const finOtro = new Date(otroEvento.fecha_fin);
                                if (inicioEvento <= finOtro && finEvento >= inicioOtro) {
                                    solapado = true;
                                    break;
                                }
                            }
                            return { ...evento, backgroundColor: solapado ? '#e74c3c' : '#3498db', borderColor: solapado ? '#c0392b' : '#2980b9' };
                        });
                        const eventosFinales = dataProcesada.map(evento => ({
                            id: evento.id, title: evento.nombre, start: evento.fecha_inicio,
                            end: new Date(new Date(evento.fecha_fin).getTime() + 86400000).toISOString().split('T')[0],
                            backgroundColor: evento.backgroundColor, borderColor: evento.borderColor
                        }));
                        successCallback(eventosFinales);
                    })
                    .catch(error => {
                        failureCallback(error);
                        Swal.fire('Error', 'No se pudieron cargar las vacaciones en el calendario.', 'error');
                    });
                }
            });
            calendario.render();
        }

        async function handleEventClick(event) {
            const { value: action } = await Swal.fire({
                title: `Gestionar vacaciones de ${event.title}`,
                text: `Del ${new Date(event.start).toLocaleDateString()} al ${new Date(new Date(event.end).getTime() - 86400000).toLocaleDateString()}`,
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: '✏️ Editar',
                denyButtonText: `🗑️ Eliminar`,
                cancelButtonText: 'Cancelar'
            });
            if (action === true) handleEditVacation(event);
            else if (action === false) handleDeleteVacation(event);
        }

        async function handleEditVacation(event) {
            const fechaInicioActual = new Date(event.start).toISOString().split('T')[0];
            const fechaFinActual = new Date(new Date(event.end).getTime() - 86400000).toISOString().split('T')[0];
            const { value: formValues } = await Swal.fire({
                title: `Editar vacaciones de ${event.title}`,
                html: `
                    <label for="swal-fecha-inicio" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Inicio:</label>
                    <input id="swal-fecha-inicio" type="date" class="swal2-input" value="${fechaInicioActual}">
                    <label for="swal-fecha-fin" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Fin:</label>
                    <input id="swal-fecha-fin" type="date" class="swal2-input" value="${fechaFinActual}">`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar Cambios',
                preConfirm: () => ({
                    fechaInicio: document.getElementById('swal-fecha-inicio').value,
                    fechaFin: document.getElementById('swal-fecha-fin').value
                })
            });
            if (formValues) {
                try {
                    const res = await fetch(`/api/vacaciones/${event.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¡Actualizado!', data.message, 'success');
                    calendario.refetchEvents();
                    mostrarDiasRestantes();
                } catch (error) {
                    Swal.fire('Error', `No se pudo actualizar: ${error.message}`, 'error');
                }
            }
        }

        async function handleDeleteVacation(event) {
            const result = await Swal.fire({
                title: '¿Estás seguro?',
                text: `Se eliminarán las vacaciones de ${event.title}. ¡Esta acción no se puede revertir!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, ¡eliminar!',
                cancelButtonText: 'Cancelar'
            });
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/vacaciones/${event.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¡Eliminado!', data.message, 'success');
                    calendario.refetchEvents();
                    mostrarDiasRestantes();
                } catch (error) {
                    Swal.fire('Error', `No se pudo eliminar: ${error.message}`, 'error');
                }
            }
        }

        async function mostrarDiasRestantes() {
            const usuarioId = document.getElementById('vacacionesUsuario').value;
            const infoSpan = document.getElementById('infoDiasRestantes');
            if (!usuarioId) {
                infoSpan.textContent = '';
                return;
            }
            try {
                const res = await fetch(`/api/usuarios/${usuarioId}/vacaciones-restantes`, { headers: { Authorization: `Bearer ${token}` } });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                window.vacationData = data; 
                const desglose = `(Base: ${data.diasBase} + Acumulados: ${data.diasAcumulados})`;
                infoSpan.innerHTML = `Disponibles: <span style="color: green;">${data.diasRestantes}</span> / ${data.diasTotales} ${desglose} (Gastados: ${data.diasGastados})`;
            } catch (error) {
                infoSpan.textContent = 'Error al calcular días.';
                infoSpan.style.color = 'red';
                window.vacationData = null;
            }
        }
        
        document.getElementById('vacacionesUsuario').addEventListener('change', mostrarDiasRestantes);

        document.getElementById('formVacaciones').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usuarioId = document.getElementById('vacacionesUsuario').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!window.vacationData || !fechaInicio || !fechaFin) {
                Swal.fire('Error', 'Por favor, selecciona un trabajador y las fechas.', 'error');
                return;
            }
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            const diffTime = Math.abs(fin - inicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            if (diffDays > window.vacationData.diasRestantes) {
                Swal.fire({ icon: 'warning', title: 'Días insuficientes', text: `Estás intentando asignar ${diffDays} días, pero al trabajador solo le quedan ${window.vacationData.diasRestantes} disponibles.` });
                return;
            }

            try {
                const res = await fetch('/api/vacaciones', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, 
                    body: JSON.stringify({ usuarioId, fechaInicio, fechaFin }) 
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                
                Swal.fire('¡Éxito!', 'Vacaciones asignadas.', 'success');
                e.target.reset();
                calendario.refetchEvents();
                mostrarDiasRestantes(); 
            } catch (error) { 
                Swal.fire('Error', `No se pudo asignar: ${error.message}`, 'error'); 
            }
        });
        
        function inicializarPagina() {
            document.getElementById("fecha").valueAsDate = new Date();
            const hoy = new Date(), offset = hoy.getTimezoneOffset(), hoyLocal = new Date(hoy.getTime() - (offset*60*1000));
            document.getElementById('manualFechaHora').value = hoyLocal.toISOString().slice(0, 16);
            selectMes.value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
            getReport();
            loadUsers();
            poblarSelectorUsuarios('selectUsuario');
            poblarSelectorUsuarios('manualUsuario');
            poblarSelectorUsuarios('vacacionesUsuario');
            inicializarCalendario();
            const fechaInicioInput = document.getElementById('fechaInicio'), fechaFinInput = document.getElementById('fechaFin');
            fechaInicioInput.addEventListener('change', () => {
                const fechaInicioSeleccionada = fechaInicioInput.value;
                if (fechaInicioSeleccionada) {
                    fechaFinInput.value = fechaInicioSeleccionada;
                    fechaFinInput.min = fechaInicioSeleccionada;
                }
            });
        }

        inicializarPagina();
    </script>
</body>
</html>