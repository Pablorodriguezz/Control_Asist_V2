<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administrador</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#e91e63" />
  </head>
  <body class="admin-page">
    <header class="mobile-header">
      <button id="hamburger-btn" aria-label="Abrir menú">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <span class="mobile-header-title">Panel de Admin</span>
    </header>

    <div class="overlay"></div>

    <div class="admin-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h1>Panel Admin</h1>
        </div>
        <nav class="admin-nav">
          <ul>
            <li>
              <a href="#dashboard"
                ><i class="bi bi-grid-1x2-fill"></i> Panel de Control</a
              >
            </li>
            <li>
              <a href="#solicitudes-pendientes"
                ><i class="bi bi-envelope-paper-fill"></i> Solicitudes</a
              >
            </li>
            <li>
              <a href="#gestion-justificantes"
                ><i class="bi bi-file-earmark-medical-fill"></i>
                Justificantes</a
              >
            </li>
            <li>
              <a href="#informe-diario"
                ><i class="bi bi-calendar-day-fill"></i> Informe Diario</a
              >
            </li>
            <li>
              <a href="#informe-mensual"
                ><i class="bi bi-calendar-month-fill"></i> Informe Mensual</a
              >
            </li>
            <li>
              <a href="#gestion-usuarios"
                ><i class="bi bi-people-fill"></i> Gestión Usuarios</a
              >
            </li>
            <li>
              <a href="#crear-usuario"
                ><i class="bi bi-person-plus-fill"></i> Crear Usuario</a
              >
            </li>
            <li>
              <a href="#fichaje-manual"
                ><i class="bi bi-pencil-square"></i> Fichaje Manual</a
              >
            </li>
            <li>
              <a href="#gestion-vacaciones"
                ><i class="bi bi-calendar"></i> Gestión Vacaciones</a
              >
            </li>
            <li>
              <a href="#gestion-nominas"
                ><i class="bi bi-file-earmark-text-fill"></i> Gestión Nóminas</a
              >
            </li>
          </ul>
        </nav>
        <div class="sidebar-footer">
          <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
        </div>
      </aside>

      <main class="main-content-area">
        <section id="dashboard">
          <div class="section-header">
            <h2>Panel de Control en Tiempo Real</h2>
          </div>

          <div class="dashboard-grid">
            <div class="widget">
              <h3>
                <i class="bi bi-person-check-fill"></i> Empleados Fichados
              </h3>
              <ul id="empleados-dentro" class="employee-list">
                <li>Cargando...</li>
              </ul>
            </div>
            <div class="widget">
              <h3><i class="bi bi-person-x-fill"></i> Empleados Fuera</h3>
              <ul id="empleados-fuera" class="employee-list">
                <li>Cargando...</li>
              </ul>
            </div>
            <div class="widget">
              <h3><i class="bi bi-calendar-x"></i> Ausencias Hoy</h3>
              <ul id="ausencias-hoy" class="employee-list">
                <li>Cargando...</li>
              </ul>
            </div>
            <div class="widget">
              <h3><i class="bi bi-card-list"></i> Resumen del Día</h3>
              <p id="total-fichajes">
                <strong>Total de fichajes hoy:</strong> <span>Cargando...</span>
              </p>
              <p id="fichajes-manuales">
                <strong>Fichajes manuales/editados:</strong>
                <span>Cargando...</span>
              </p>
            </div>
          </div>
        </section>
        <hr />

        <section id="solicitudes-pendientes">
          <h2>Solicitudes de Vacaciones Pendientes</h2>
          <div class="table-container">
            <table id="tablaSolicitudes">
              <thead>
                <tr>
                  <th>Empleado</th>
                  <th>Periodo Solicitado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
        <hr />

        <section id="gestion-justificantes">
          <h2>Justificantes Recibidos</h2>
          <div class="table-container">
            <table id="tablaJustificantes">
              <thead>
                <tr>
                  <th>Empleado</th>
                  <th>Periodo Ausencia</th>
                  <th>Motivo</th>
                  <th>Fecha de Envío</th>
                  <th>Archivo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
        <hr />

        <section id="informe-diario">
          <h2>Informe de Asistencia Diario</h2>
          <input type="date" id="fecha" onchange="getReport()" />
          <div class="table-container">
            <table id="reportTable">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Fecha y Hora</th>
                  <th>Tipo</th>
                  <th>Foto</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
        <hr />

        <section id="informe-mensual">
          <h2>Informe Mensual por Trabajador</h2>
          <div>
            <select id="selectUsuario" required>
              <option value="">-- Selecciona un trabajador --</option>
            </select>
            <input type="month" id="selectMes" required /><button
              onclick="generarInformeMensual()"
            >
              Generar Informe
            </button>
            <button
              id="btnExportar"
              style="display: none"
              onclick="exportarCSV()"
            >
              Exportar a CSV
            </button>
          </div>
          <div id="informeMensualContainer" style="margin-top: 20px"></div>
        </section>
        <hr />

        <section id="gestion-usuarios">
          <h2>Gestión de Usuarios</h2>
          <div class="table-container">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Usuario</th>
                  <th>Rol</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
        <hr />

        <section id="crear-usuario">
          <h2>Crear Nuevo Usuario</h2>
          <form id="createUserForm">
            <input
              type="text"
              id="nombre"
              placeholder="Nombre completo"
              required
            /><input
              type="text"
              id="usuario"
              placeholder="Nombre de usuario (login)"
              required
            /><input
              type="password"
              id="password"
              placeholder="Contraseña"
              required
            />
            <label
              for="fechaContratacion"
              style="text-align: left; margin-top: 10px"
              >Fecha de Contratación:</label
            ><input type="date" id="fechaContratacion" required />
            <select id="rol" required>
              <option value="empleado" selected>Empleado</option>
              <option value="admin">Administrador</option>
              <option value="gestor_vacaciones">Gestor de Vacaciones</option>
            </select>
            <button type="submit" class="btn-create">Crear Usuario</button>
          </form>
        </section>
        <hr />

        <section id="fichaje-manual">
          <h2>Crear Fichaje Manual</h2>
          <form id="manualAttendanceForm">
            <label for="manualUsuario">Trabajador:</label
            ><select id="manualUsuario" required>
              <option value="">-- Selecciona un trabajador --</option>
            </select>
            <label for="manualFechaHora">Fecha y Hora del Fichaje:</label
            ><input type="datetime-local" id="manualFechaHora" required />
            <label for="manualTipo">Tipo de Fichaje:</label
            ><select id="manualTipo" required>
              <option value="" disabled selected>-- Selecciona tipo --</option>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
            <label for="manualMotivo"
              >Motivo (ej: olvido, error del sistema):</label
            ><textarea
              id="manualMotivo"
              placeholder="Es obligatorio explicar por qué se crea este fichaje."
              required
            ></textarea>
            <button type="submit">Crear Fichaje Manual</button>
          </form>
        </section>
        <hr />

        <section id="gestion-vacaciones">
          <h2>Gestión de Vacaciones</h2>
          <form id="formVacaciones">
            <label for="vacacionesUsuario">Trabajador:</label
            ><select id="vacacionesUsuario" required>
              <option value="">-- Selecciona un trabajador --</option>
            </select>
            <span
              id="infoDiasRestantes"
              style="display: block; margin-bottom: 15px; font-weight: bold"
            ></span>
            <label for="fechaInicio">Fecha de Inicio:</label
            ><input type="date" id="fechaInicio" required />
            <label for="fechaFin">Fecha de Fin:</label
            ><input type="date" id="fechaFin" required />
            <button type="submit">Asignar Vacaciones</button>
          </form>
          <hr style="margin: 20px 0" />
          <div id="calendarioVacaciones"></div>
        </section>

        <hr />
        <section id="gestion-nominas">
          <h2>
            <i class="bi bi-file-earmark-text-fill"></i> Gestión de Nóminas
          </h2>

          <form id="formSubirNomina" class="form-nominas">
            <h3>Subir Nueva Nómina</h3>

            <div class="form-group">
              <label for="nominaUsuario">Selecciona Empleado</label>
              <select id="nominaUsuario" required>
                <option value="">-- Selecciona un trabajador --</option>
              </select>
            </div>

            <div class="form-group">
              <label for="nominaMesAnio">Selecciona Mes y Año</label>
              <input type="month" id="nominaMesAnio" required />
            </div>

            <div class="form-group">
              <label>Selecciona Archivo (PDF)</label>
              <input
                type="file"
                id="nominaArchivo"
                accept=".pdf"
                required
                style="display: none"
              />
              <div class="file-upload-container">
                <label for="nominaArchivo" class="custom-file-upload">
                  <i class="bi bi-upload"></i>
                  Seleccionar archivo
                </label>
                <span id="fileNameDisplay" class="file-name-display"
                  >Ningún archivo seleccionado</span
                >
              </div>
            </div>

            <div class="form-group submit-group">
              <button type="submit">Subir Nómina</button>
            </div>
          </form>

          <div class="historial-nominas">
            <h3>Historial de Nóminas Enviadas</h3>
            <div class="table-container">
              <table id="tablaNominasAdmin">
                <thead>
                  <tr>
                    <th>Empleado</th>
                    <th>Periodo</th>
                    <th>Nombre del Archivo</th>
                    <th>Fecha de Subida</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <button id="scrollTopBtn" title="Volver arriba">⇧</button>
    
    <!-- INICIO: CONTADOR DE AUTO-REFRESH -->
    <div id="autoRefreshCounter">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        fill="currentColor"
        viewBox="0 0 16 16"
      >
        <path
          fill-rule="evenodd"
          d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"
        />
        <path
          d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"
        />
      </svg>
      AUTOREFRESH IN ... <span id="countdown">30</span>
    </div>
    <!-- FIN: CONTADOR DE AUTO-REFRESH -->


    <script>
      const token = localStorage.getItem("token");
      if (!token) window.location.href = "/index.html";
      const selectUsuario = document.getElementById("selectUsuario");
      const selectMes = document.getElementById("selectMes");
      const btnExportar = document.getElementById("btnExportar");
      let calendario;
      let vacationData;

      function calcularDiasLaborables(fechaInicio, fechaFin) {
        const inicio = new Date(fechaInicio);
        const fin = new Date(fechaFin);
        let count = 0;
        const curDate = new Date(
          Date.UTC(
            inicio.getUTCFullYear(),
            inicio.getUTCMonth(),
            inicio.getUTCDate()
          )
        );
        const finalDate = new Date(
          Date.UTC(fin.getUTCFullYear(), fin.getUTCMonth(), fin.getUTCDate())
        );
        while (curDate <= finalDate) {
          const dayOfWeek = curDate.getUTCDay();
          if (dayOfWeek !== 0 && dayOfWeek !== 6) {
            count++;
          }
          curDate.setUTCDate(curDate.getUTCDate() + 1);
        }
        return count;
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/index.html";
      }

      async function cargarDashboard() {
        const ids = {
          dentro: document.getElementById("empleados-dentro"),
          fuera: document.getElementById("empleados-fuera"),
          ausencias: document.getElementById("ausencias-hoy"),
          total: document.querySelector("#total-fichajes span"),
          manuales: document.querySelector("#fichajes-manuales span"),
        };
        try {
          const res = await fetch("/api/dashboard", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("No se pudo cargar el dashboard.");
          const data = await res.json();
          const rellenarLista = (ulElement, items) => {
            ulElement.innerHTML = "";
            if (items.length === 0) {
              ulElement.innerHTML = "<li></li>";
            } else {
              items.forEach((item) => {
                const li = document.createElement("li");
                li.textContent = item;
                ulElement.appendChild(li);
              });
            }
          };
          rellenarLista(ids.dentro, data.empleadosDentro);
          rellenarLista(ids.fuera, data.empleadosFuera);
          rellenarLista(ids.ausencias, data.ausenciasHoy);
          ids.total.textContent = data.resumen.totalFichajes;
          ids.manuales.textContent = data.resumen.fichajesManuales;
        } catch (error) {
          console.error("Error en cargarDashboard:", error);
          Object.values(ids).forEach((el) => {
            if (el.tagName === "UL") el.innerHTML = "<li>Error al cargar</li>";
            else if (el.tagName === "SPAN") el.textContent = "Error";
          });
        }
      }

      async function getReport() {
        const fecha = document.getElementById("fecha").value;
        if (!fecha) return;
        try {
          const res = await fetch(`/api/informe?fecha=${fecha}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Error al cargar informe diario");
          const data = await res.json();
          const tbody = document.querySelector("#reportTable tbody");
          tbody.innerHTML = "";
          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5">No hay registros para esta fecha.</td></tr>';
          } else {
            data.forEach((row) => {
              const tr = document.createElement("tr");
              const fechaHora = new Date(row.fecha_hora).toLocaleString(
                "es-ES",
                { dateStyle: "short", timeStyle: "medium" }
              );
              const fotoHtml = row.foto_path
                ? `<a href="${row.foto_path}" target="_blank"><img src="${row.foto_path}" alt="Foto fichaje" class="photo-thumbnail"></a>`
                : "Sin foto";
              let indicadorEditado = "";
              if (row.es_modificado) {
                const fechaOriginal = row.fecha_hora_original
                  ? new Date(row.fecha_hora_original).toLocaleString("es-ES")
                  : "N/A";
                const motivo = row.motivo_modificacion
                  ? row.motivo_modificacion.replace(/"/g, '"')
                  : "N/A";
                const title = row.fecha_hora_original
                  ? `Editado. Original: ${fechaOriginal}. Motivo: ${motivo}`
                  : `Registro manual. Motivo: ${motivo}`;
                indicadorEditado = `<span title="${title}" style="cursor: help; color: #f39c12; font-weight: bold;"> ✏️</span>`;
              }
              tr.innerHTML = `<td>${row.nombre}</td><td>${fechaHora}${indicadorEditado}</td><td>${row.tipo}</td><td>${fotoHtml}</td><td><button class="action-btn btn-reset" onclick="abrirModalEdicion(${row.id}, '${row.fecha_hora}', '${row.nombre}')">Editar</button><button class="action-btn btn-delete" onclick="eliminarRegistro(${row.id}, '${row.nombre}', '${fechaHora}')">Eliminar</button></td>`;
              tbody.appendChild(tr);
            });
          }
        } catch (error) {
          document.querySelector("#reportTable tbody").innerHTML =
            '<tr><td colspan="5">Error al cargar datos.</td></tr>';
        }
      }

      async function abrirModalEdicion(
        registroId,
        fechaHoraActual,
        nombreUsuario
      ) {
        const fechaActualDate = new Date(fechaHoraActual);
        const year = fechaActualDate.getFullYear();
        const month = String(fechaActualDate.getMonth() + 1).padStart(2, "0");
        const day = String(fechaActualDate.getDate()).padStart(2, "0");
        const hours = String(fechaActualDate.getHours()).padStart(2, "0");
        const minutes = String(fechaActualDate.getMinutes()).padStart(2, "0");
        const fechaParaInput = `${year}-${month}-${day}T${hours}:${minutes}`;
        const { value: formValues } = await Swal.fire({
          title: `Editar fichaje de ${nombreUsuario}`,
          html: `<p style="margin-bottom: 1rem;">Fecha y Hora Actual: ${fechaActualDate.toLocaleString()}</p>
                 <label for="swal-input-fecha">Nueva Fecha y Hora:</label>
                 <input id="swal-input-fecha" type="datetime-local" value="${fechaParaInput}" class="swal2-input" style="width: auto; margin-top: 0.5rem;">
                 <textarea id="swal-input-motivo" class="swal2-textarea" placeholder="Motivo de la edición (obligatorio)" style="margin-top: 1rem;"></textarea>`,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: "Guardar Cambios",
          cancelButtonText: "Cancelar",
          preConfirm: () => {
            const nuevaFechaHora =
              document.getElementById("swal-input-fecha").value;
            const motivo = document
              .getElementById("swal-input-motivo")
              .value.trim();
            if (!nuevaFechaHora || !motivo) {
              Swal.showValidationMessage(
                "Por favor, completa la nueva fecha/hora y el motivo."
              );
              return false;
            }
            return { nuevaFechaHora, motivo };
          },
        });
        if (formValues) {
          try {
            const res = await fetch(`/api/registros/${registroId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formValues),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire(
              "¡Actualizado!",
              "El registro ha sido modificado con éxito.",
              "success"
            );
            getReport();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo actualizar: ${error.message}`,
              "error"
            );
          }
        }
      }

      async function cargarJustificantes() {
        const tbody = document.querySelector("#tablaJustificantes tbody");
        tbody.innerHTML =
          '<tr><td colspan="6">Cargando justificantes...</td></tr>';
        try {
          const res = await fetch("/api/justificantes", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok)
            throw new Error("No se pudieron cargar los justificantes.");
          const justificantes = await res.json();
          tbody.innerHTML = "";
          if (justificantes.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6">No se han recibido justificantes.</td></tr>';
            return;
          }
          justificantes.forEach((j) => {
            const tr = document.createElement("tr");
            const fInicio = new Date(j.fecha_inicio).toLocaleDateString(
              "es-ES"
            );
            const fFin = new Date(j.fecha_fin).toLocaleDateString("es-ES");
            const fSubida = new Date(j.fecha_subida).toLocaleString("es-ES");
            const motivoEscapado = j.motivo
              ? j.motivo.replace(/'/g, "\\'").replace(/"/g, "&quot;")
              : "";
            tr.innerHTML = `
                    <td>${j.nombre_empleado}</td>
                    <td>Del ${fInicio} al ${fFin}</td>
                    <td>${j.motivo || "N/A"}</td>
                    <td>${fSubida}</td>
                    <td><a href="${
                      j.archivo_path
                    }" class="action-btn" target="_blank" rel="noopener noreferrer">Ver</a></td>
                    <td>
                        <button class="action-btn btn-reset" onclick="editarJustificante(${
                          j.id
                        }, '${j.fecha_inicio}', '${
              j.fecha_fin
            }', '${motivoEscapado}', '${j.nombre_empleado}')">Editar</button>
                        <button class="action-btn btn-delete" onclick="eliminarJustificante(${
                          j.id
                        }, '${j.nombre_empleado}')">Eliminar</button>
                    </td>
                `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          tbody.innerHTML = `<tr><td colspan="6">Error al cargar los justificantes: ${error.message}</td></tr>`;
        }
      }

      async function editarJustificante(
        id,
        fechaInicio,
        fechaFin,
        motivo,
        nombreEmpleado
      ) {
        const fechaInicioInput = new Date(fechaInicio)
          .toISOString()
          .split("T")[0];
        const fechaFinInput = new Date(fechaFin).toISOString().split("T")[0];
        const { value: formValues } = await Swal.fire({
          title: `Editar justificante de ${nombreEmpleado}`,
          html: `
                <label for="swal-fecha-inicio" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Inicio:</label>
                <input id="swal-fecha-inicio" type="date" class="swal2-input" value="${fechaInicioInput}">
                
                <label for="swal-fecha-fin" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Fin:</label>
                <input id="swal-fecha-fin" type="date" class="swal2-input" value="${fechaFinInput}">

                <label for="swal-motivo" style="display: block; text-align: left; margin-top: 1rem;">Motivo:</label>
                <textarea id="swal-motivo" class="swal2-textarea">${motivo}</textarea>
            `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: "Guardar Cambios",
          preConfirm: () => {
            return {
              fechaInicio: document.getElementById("swal-fecha-inicio").value,
              fechaFin: document.getElementById("swal-fecha-fin").value,
              motivo: document.getElementById("swal-motivo").value,
            };
          },
        });
        if (formValues) {
          try {
            const res = await fetch(`/api/justificantes/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formValues),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire(
              "¡Actualizado!",
              "El justificante ha sido modificado.",
              "success"
            );
            cargarJustificantes();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo actualizar: ${error.message}`,
              "error"
            );
          }
        }
      }

      async function eliminarJustificante(id, nombreEmpleado) {
        const result = await Swal.fire({
          title: "¿Estás seguro?",
          text: `Se eliminará permanentemente el justificante de ${nombreEmpleado}. ¡Esta acción no se puede revertir!`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Sí, ¡eliminar!",
          cancelButtonText: "Cancelar",
        });
        if (result.isConfirmed) {
          try {
            const res = await fetch(`/api/justificantes/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire(
              "¡Eliminado!",
              "El justificante ha sido eliminado.",
              "success"
            );
            cargarJustificantes();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo eliminar: ${error.message}`,
              "error"
            );
          }
        }
      }

      async function eliminarRegistro(
        registroId,
        nombreUsuario,
        fechaHoraFormateada
      ) {
        Swal.fire({
          title: `¿Estás seguro?`,
          html: `Se eliminará permanentemente el fichaje de <strong>${nombreUsuario}</strong> de la fecha <strong>${fechaHoraFormateada}</strong>. <br><br><strong>¡Esta acción no se puede revertir!</strong>`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Sí, ¡eliminar!",
          cancelButtonText: "Cancelar",
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const res = await fetch(`/api/registros/${registroId}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.message);
              Swal.fire(
                "¡Eliminado!",
                "El registro ha sido eliminado.",
                "success"
              );
              getReport();
            } catch (error) {
              Swal.fire(
                "Error",
                `No se pudo eliminar: ${error.message}`,
                "error"
              );
            }
          }
        });
      }

      async function loadUsers() {
        try {
          const res = await fetch("/api/usuarios", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok)
            throw new Error("No se pudo cargar la lista de usuarios.");
          const users = await res.json();
          const tbody = document.querySelector("#usersTable tbody");
          tbody.innerHTML = "";
          users.forEach((user) => {
            const tr = document.createElement("tr");
            const diasCompensatorios = user.dias_compensatorios || 0;
            tr.innerHTML = `
                <td>${user.nombre}</td>
                <td>${user.usuario}</td>
                <td>${user.rol}</td>
                <td>
                    <button class="action-btn" style="background-color: #3498db;" onclick="ajustarDiasCompensatorios(${user.id}, '${user.nombre}', ${diasCompensatorios})">Ajustar Días</button>
                    <button class="action-btn btn-reset" onclick="resetPassword(${user.id}, '${user.nombre}')">Resetear</button>
                    <button class="action-btn btn-delete" onclick="deleteUser(${user.id}, '${user.nombre}')">Eliminar</button>
                </td>`;
            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error("Error en loadUsers:", error);
        }
      }

      async function resetPassword(userId, userName) {
        const { value: newPassword } = await Swal.fire({
          title: `Nueva contraseña para ${userName}`,
          input: "password",
          inputLabel: "Contraseña",
          inputPlaceholder: "Introduce la nueva contraseña",
          showCancelButton: true,
          confirmButtonText: "Restablecer",
          cancelButtonText: "Cancelar",
          inputValidator: (value) =>
            !value && "¡Necesitas escribir una contraseña!",
        });
        if (newPassword) {
          try {
            const res = await fetch(`/api/usuarios/${userId}/password`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ password: newPassword }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire("¡Éxito!", data.message, "success");
          } catch (error) {
            Swal.fire("Error", error.message, "error");
          }
        }
      }

      async function deleteUser(userId, userName) {
        Swal.fire({
          title: `¿Estás seguro de eliminar a ${userName}?`,
          text: "¡Esta acción no se puede revertir!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Sí, ¡eliminar!",
          cancelButtonText: "Cancelar",
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const res = await fetch(`/api/usuarios/${userId}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.message);
              Swal.fire(
                "¡Eliminado!",
                "El usuario ha sido eliminado.",
                "success"
              );
              loadUsers();
              poblarSelectorUsuarios("selectUsuario");
              poblarSelectorUsuarios("manualUsuario");
              poblarSelectorUsuarios("vacacionesUsuario");
            } catch (error) {
              Swal.fire("Error", error.message, "error");
            }
          }
        });
      }

      async function poblarSelectorUsuarios(selectorId) {
        const selectElement = document.getElementById(selectorId);
        try {
          const res = await fetch("/api/usuarios", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const usuarios = await res.json();
          const defaultOptionHTML =
            selectElement.querySelector('option[value=""]').outerHTML;
          selectElement.innerHTML = defaultOptionHTML;
          usuarios.forEach((user) => {
            if (user.rol === "empleado") {
              const option = document.createElement("option");
              option.value = user.id;
              option.textContent = user.nombre;
              selectElement.appendChild(option);
            }
          });
        } catch (error) {
          console.error(
            `Error en poblarSelectorUsuarios para #${selectorId}:`,
            error
          );
        }
      }

      async function ajustarDiasCompensatorios(userId, userName, currentDays) {
        const { value: formValues } = await Swal.fire({
          title: `Ajustar días de ${userName}`,
          html: `
            <p style="margin-bottom: 1rem;">Días compensatorios actuales: <strong>${currentDays}</strong></p>
            <label for="swal-input-dias">Nuevos días compensatorios:</label>
            <input id="swal-input-dias" type="number" min="0" value="${currentDays}" class="swal2-input" style="width: auto; margin-top: 0.5rem;">
            <textarea id="swal-input-motivo" class="swal2-textarea" placeholder="Motivo del ajuste (ej: trabajo en festivo)" style="margin-top: 1rem;"></textarea>
        `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: "Guardar Cambios",
          preConfirm: () => {
            const dias = parseInt(
              document.getElementById("swal-input-dias").value,
              10
            );
            const motivo = document
              .getElementById("swal-input-motivo")
              .value.trim();
            if (isNaN(dias) || dias < 0) {
              Swal.showValidationMessage(
                "Por favor, introduce un número válido de días (0 o más)."
              );
              return false;
            }
            if (!motivo) {
              Swal.showValidationMessage(
                "Es obligatorio indicar un motivo para el ajuste."
              );
              return false;
            }
            return { dias, motivo };
          },
        });
        if (formValues) {
          try {
            const res = await fetch(
              `/api/usuarios/${userId}/dias-compensatorios`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(formValues),
              }
            );
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire("¡Actualizado!", data.message, "success");
            loadUsers();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo actualizar: ${error.message}`,
              "error"
            );
          }
        }
      }

      async function generarInformeMensual() {
        const usuarioId = selectUsuario.value;
        const mesValue = selectMes.value;
        if (!usuarioId) {
          Swal.fire("Atención", "Selecciona un trabajador.", "info");
          return;
        }
        if (!mesValue) {
          Swal.fire("Atención", "Selecciona un mes.", "info");
          return;
        }
        const [anio, mes] = mesValue.split("-");
        const container = document.getElementById("informeMensualContainer");
        container.innerHTML = "Generando informe...";
        btnExportar.style.display = "none";
        try {
          const url = `/api/informe-mensual?anio=${anio}&mes=${mes}&usuarioId=${usuarioId}`;
          const res = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) {
            const errData = await res
              .json()
              .catch(() => ({ message: `Error: ${res.status}` }));
            throw new Error(errData.message);
          }
          const informe = await res.json();
          const segundosAFormatoHora = (s) =>
            new Date((s || 0) * 1000).toISOString().substr(11, 8);
          let html = `<h3>Informe para ${
            selectUsuario.options[selectUsuario.selectedIndex].text
          }</h3>`;
          if (Object.keys(informe.resumenSemanas).length === 0) {
            html += "<p>No hay datos de trabajo para el mes seleccionado.</p>";
            container.innerHTML = html;
            return;
          }
          html += "<h4>Resumen Semanal:</h4><ul>";
          for (const numSemana in informe.resumenSemanas) {
            const semana = informe.resumenSemanas[numSemana];
            html += `<li><strong>Semana ${numSemana}:</strong><ul><li>Horas Trabajadas: ${segundosAFormatoHora(
              semana.totalSegundos
            )}</li><li>Horas Extra (sobre 40h/sem): ${segundosAFormatoHora(
              semana.horasExtraSegundos
            )}</li></ul></li>`;
          }
          html += '</ul><hr style="margin: 20px 0;">';
          html += `<p><strong>Total Horas en el Mes:</strong> ${segundosAFormatoHora(
            informe.totalHorasMesSegundos
          )}</p>`;
          html += `<p><strong>Total Horas Extra en el Mes:</strong> ${segundosAFormatoHora(
            informe.totalHorasExtraMesSegundos
          )}</p>`;
          container.innerHTML = html;
          if (informe.totalHorasMesSegundos > 0)
            btnExportar.style.display = "inline-block";
        } catch (error) {
          Swal.fire(
            "Error",
            `No se pudo generar el informe: ${error.message}`,
            "error"
          );
          container.innerHTML = "";
        }
      }

      async function exportarCSV() {
        const usuarioId = selectUsuario.value;
        const [anio, mes] = selectMes.value.split("-");
        if (!usuarioId) return;
        btnExportar.textContent = "Exportando...";
        btnExportar.disabled = true;
        try {
          const url = `/api/exportar-csv?anio=${anio}&mes=${mes}&usuarioId=${usuarioId}`;
          const res = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) {
            const errorData = await res
              .json()
              .catch(() => ({ message: `Error: ${res.status}` }));
            throw new Error(errorData.message);
          }
          const blob = await res.blob();
          const contentDisposition = res.headers.get("content-disposition");
          let fileName = `informe-${anio}-${mes}.csv`;
          if (contentDisposition) {
            const fileNameMatch = contentDisposition.match(/filename="(.+)"/);
            if (fileNameMatch.length === 2) fileName = fileNameMatch[1];
          }
          const link = document.createElement("a");
          link.href = window.URL.createObjectURL(blob);
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(link.href);
        } catch (error) {
          Swal.fire("Error", `No se pudo exportar: ${error.message}`, "error");
        } finally {
          btnExportar.textContent = "Exportar a CSV";
          btnExportar.disabled = false;
        }
      }

      document
        .getElementById("createUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const [nombre, usuario, password, rol, fechaContratacion] = [
            e.target.nombre.value,
            e.target.usuario.value,
            e.target.password.value,
            e.target.rol.value,
            e.target.fechaContratacion.value,
          ];
          try {
            const res = await fetch("/api/usuarios", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                nombre,
                usuario,
                password,
                rol,
                fechaContratacion,
              }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire({
              title: "¡Usuario Creado!",
              text: data.message,
              icon: "success",
              timer: 2000,
              showConfirmButton: false,
            });
            e.target.reset();
            loadUsers();
            poblarSelectorUsuarios("selectUsuario");
            poblarSelectorUsuarios("manualUsuario");
            poblarSelectorUsuarios("vacacionesUsuario");
          } catch (error) {
            Swal.fire("Error", error.message, "error");
          }
        });

      document
        .getElementById("manualAttendanceForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const usuarioId = document.getElementById("manualUsuario").value;
          const fechaHora = document.getElementById("manualFechaHora").value;
          const tipo = document.getElementById("manualTipo").value;
          const motivo = document.getElementById("manualMotivo").value;
          if (!usuarioId || !fechaHora || !tipo || !motivo) {
            Swal.fire("Error", "Completa todos los campos.", "error");
            return;
          }
          try {
            const res = await fetch("/api/fichaje-manual", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ usuarioId, fechaHora, tipo, motivo }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire({
              title: "¡Éxito!",
              text: data.message,
              icon: "success",
              timer: 2000,
              showConfirmButton: false,
            });
            e.target.reset();
            getReport();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo crear el fichaje: ${error.message}`,
              "error"
            );
          }
        });

      function inicializarCalendario() {
        const calendarioEl = document.getElementById("calendarioVacaciones");
        calendario = new FullCalendar.Calendar(calendarioEl, {
          initialView: "dayGridMonth",
          locale: "es",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,listWeek",
          },
          eventClick: function (info) {
            handleEventClick(info.event);
          },
          events: function (fetchInfo, successCallback, failureCallback) {
            fetch("/api/vacaciones", {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            })
              .then((res) =>
                res.ok
                  ? res.json()
                  : Promise.reject("Respuesta no válida del servidor")
              )
              .then((data) => {
                const dataProcesada = data.map((evento) => {
                  let solapado = false;
                  const inicioEvento = new Date(evento.fecha_inicio);
                  const finEvento = new Date(evento.fecha_fin);
                  for (const otroEvento of data) {
                    if (evento.id === otroEvento.id) continue;
                    const inicioOtro = new Date(otroEvento.fecha_inicio);
                    const finOtro = new Date(otroEvento.fecha_fin);
                    if (inicioEvento <= finOtro && finEvento >= inicioOtro) {
                      solapado = true;
                      break;
                    }
                  }
                  return {
                    ...evento,
                    backgroundColor: solapado ? "#e74c3c" : "#3498db",
                    borderColor: solapado ? "#c0392b" : "#2980b9",
                  };
                });
                const eventosFinales = dataProcesada.map((evento) => ({
                  id: evento.id,
                  title: evento.nombre,
                  start: evento.fecha_inicio,
                  end: new Date(new Date(evento.fecha_fin).getTime() + 86400000)
                    .toISOString()
                    .split("T")[0],
                  backgroundColor: evento.backgroundColor,
                  borderColor: evento.borderColor,
                }));
                successCallback(eventosFinales);
              })
              .catch((error) => {
                failureCallback(error);
                Swal.fire(
                  "Error",
                  "No se pudieron cargar las vacaciones en el calendario.",
                  "error"
                );
              });
          },
        });
        const nominaArchivoInput = document.getElementById("nominaArchivo");
        const fileNameDisplay = document.getElementById("fileNameDisplay");
        if (nominaArchivoInput && fileNameDisplay) {
          nominaArchivoInput.addEventListener("change", () => {
            if (nominaArchivoInput.files.length > 0) {
              fileNameDisplay.textContent = nominaArchivoInput.files[0].name;
            } else {
              fileNameDisplay.textContent = "Ningún archivo seleccionado";
            }
          });
        }
        calendario.render();
      }

      async function handleEventClick(event) {
        const { value: action } = await Swal.fire({
          title: `Gestionar vacaciones de ${event.title}`,
          text: `Del ${new Date(
            event.start
          ).toLocaleDateString()} al ${new Date(
            new Date(event.end).getTime() - 86400000
          ).toLocaleDateString()}`,
          showCancelButton: true,
          showDenyButton: true,
          confirmButtonText: "✏️ Editar",
          denyButtonText: `🗑️ Eliminar`,
          cancelButtonText: "Cancelar",
        });
        if (action === true) {
          handleEditVacation(event);
        } else if (action === false) {
          handleDeleteVacation(event);
        }
      }

      async function handleEditVacation(event) {
        const fechaInicioActual = new Date(event.start)
          .toISOString()
          .split("T")[0];
        const fechaFinActual = new Date(
          new Date(event.end).getTime() - 86400000
        )
          .toISOString()
          .split("T")[0];
        const { value: formValues } = await Swal.fire({
          title: `Editar vacaciones de ${event.title}`,
          html: `
            <label for="swal-fecha-inicio" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Inicio:</label>
            <input id="swal-fecha-inicio" type="date" class="swal2-input" value="${fechaInicioActual}">
            <label for="swal-fecha-fin" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Fin:</label>
            <input id="swal-fecha-fin" type="date" class="swal2-input" value="${fechaFinActual}">`,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: "Guardar Cambios",
          preConfirm: () => ({
            fechaInicio: document.getElementById("swal-fecha-inicio").value,
            fechaFin: document.getElementById("swal-fecha-fin").value,
          }),
        });
        if (formValues) {
          try {
            const res = await fetch(`/api/vacaciones/${event.id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formValues),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire("¡Actualizado!", data.message, "success");
            calendario.refetchEvents();
            mostrarDiasRestantes();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo actualizar: ${error.message}`,
              "error"
            );
          }
        }
      }

      async function handleDeleteVacation(event) {
        const result = await Swal.fire({
          title: "¿Estás seguro?",
          text: `Se eliminarán las vacaciones de ${event.title}. ¡Esta acción no se puede revertir!`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Sí, ¡eliminar!",
          cancelButtonText: "Cancelar",
        });
        if (result.isConfirmed) {
          try {
            const res = await fetch(`/api/vacaciones/${event.id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire("¡Eliminado!", data.message, "success");
            calendario.refetchEvents();
            mostrarDiasRestantes();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo eliminar: ${error.message}`,
              "error"
            );
          }
        }
      }

      async function mostrarDiasRestantes() {
        const usuarioId = document.getElementById("vacacionesUsuario").value;
        const infoSpan = document.getElementById("infoDiasRestantes");
        if (!usuarioId) {
          infoSpan.textContent = "";
          window.vacationData = null;
          return;
        }
        try {
          const res = await fetch(
            `/api/usuarios/${usuarioId}/vacaciones-restantes`,
            { headers: { Authorization: `Bearer ${token}` } }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message);
          window.vacationData = data;
          infoSpan.innerHTML = `Disponibles (laborables): <span style="color: green;">${data.diasRestantes}</span> / ${data.diasTotales} (Gastados: ${data.diasGastados})`;
        } catch (error) {
          infoSpan.textContent = "Error al calcular días.";
          infoSpan.style.color = "red";
          window.vacationData = null;
        }
      }

      async function cargarSolicitudesPendientes() {
        const tbody = document.querySelector("#tablaSolicitudes tbody");
        tbody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
        try {
          const res = await fetch("/api/vacaciones-pendientes", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const solicitudes = await res.json();
          tbody.innerHTML = "";
          if (solicitudes.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="3">No hay solicitudes pendientes.</td></tr>';
            return;
          }
          solicitudes.forEach((sol) => {
            const tr = document.createElement("tr");
            const fInicio = new Date(sol.fecha_inicio).toLocaleDateString(
              "es-ES"
            );
            const fFin = new Date(sol.fecha_fin).toLocaleDateString("es-ES");
            tr.innerHTML = `<td>${sol.nombre}</td><td>Del ${fInicio} al ${fFin}</td><td><button class="action-btn btn-success" onclick="gestionarSolicitud(${sol.id}, 'aprobada')">Aprobar</button><button class="action-btn btn-delete" onclick="gestionarSolicitud(${sol.id}, 'rechazada')">Rechazar</button></td>`;
            tbody.appendChild(tr);
          });
        } catch (error) {
          tbody.innerHTML = '<tr><td colspan="3">Error al cargar.</td></tr>';
        }
      }

      async function gestionarSolicitud(id, nuevoEstado) {
        try {
          const res = await fetch(`/api/vacaciones/${id}/gestionar`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ nuevoEstado }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message);
          Swal.fire("¡Gestionado!", data.message, "success");
          cargarSolicitudesPendientes();
          calendario.refetchEvents();
        } catch (error) {
          Swal.fire("Error", error.message, "error");
        }
      }

      document
        .getElementById("vacacionesUsuario")
        .addEventListener("change", mostrarDiasRestantes);

      document
        .getElementById("formVacaciones")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const usuarioId = document.getElementById("vacacionesUsuario").value;
          const fechaInicio = document.getElementById("fechaInicio").value;
          const fechaFin = document.getElementById("fechaFin").value;
          if (!usuarioId || !fechaInicio || !fechaFin) {
            Swal.fire(
              "Atención",
              "Debes seleccionar un trabajador y ambas fechas.",
              "warning"
            );
            return;
          }
          const diasLaborablesAsignados = calcularDiasLaborables(
            fechaInicio,
            fechaFin
          );
          if (
            window.vacationData &&
            diasLaborablesAsignados > window.vacationData.diasRestantes
          ) {
            const confirmation = await Swal.fire({
              icon: "warning",
              title: "Saldo insuficiente",
              html: `Estás asignando <strong>${diasLaborablesAsignados}</strong> días laborables, pero al trabajador solo le quedan <strong>${window.vacationData.diasRestantes}</strong> disponibles.<br><br>¿Deseas continuar de todos modos?`,
              showCancelButton: true,
              confirmButtonText: "Sí, asignar",
              cancelButtonText: "Cancelar",
            });
            if (!confirmation.isConfirmed) {
              return;
            }
          }
          try {
            const res = await fetch("/api/vacaciones", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ usuarioId, fechaInicio, fechaFin }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire("¡Éxito!", "Vacaciones asignadas.", "success");
            e.target.reset();
            calendario.refetchEvents();
            mostrarDiasRestantes();
          } catch (error) {
            Swal.fire("Error", `No se pudo asignar: ${error.message}`, "error");
          }
        });

      async function cargarNominasAdmin() {
        const tbody = document.querySelector("#tablaNominasAdmin tbody");
        tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
        try {
          const res = await fetch("/api/nominas/admin", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const nominas = await res.json();
          if (!res.ok) throw new Error(nominas.message);
          tbody.innerHTML = "";
          if (nominas.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5">No se han subido nóminas.</td></tr>';
            return;
          }
          const meses = [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre",
          ];
          nominas.forEach((n) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                      <td>${n.nombre_empleado}</td>
                      <td>${meses[n.mes - 1]} ${n.anio}</td>
                      <td>${n.nombre_archivo}</td>
                      <td>${new Date(n.fecha_subida).toLocaleString(
                        "es-ES"
                      )}</td>
                      <td><button class="action-btn btn-delete" onclick="eliminarNomina(${
                        n.id
                      }, '${n.nombre_empleado}', '${meses[n.mes - 1]} ${
              n.anio
            }')">Eliminar</button></td>
                  `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          tbody.innerHTML = `<tr><td colspan="5">Error al cargar: ${error.message}</td></tr>`;
        }
      }

      async function eliminarNomina(id, nombre, periodo) {
        const result = await Swal.fire({
          title: "¿Estás seguro?",
          html: `Se eliminará la nómina de <strong>${nombre}</strong> del periodo <strong>${periodo}</strong>. Esta acción no se puede deshacer.`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Sí, ¡eliminar!",
          cancelButtonText: "Cancelar",
        });
        if (result.isConfirmed) {
          try {
            const res = await fetch(`/api/nominas/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            Swal.fire("¡Eliminada!", "La nómina ha sido eliminada.", "success");
            cargarNominasAdmin();
          } catch (error) {
            Swal.fire(
              "Error",
              `No se pudo eliminar: ${error.message}`,
              "error"
            );
          }
        }
      }

      function inicializarPagina() {
        document.getElementById("fecha").valueAsDate = new Date();
        const hoy = new Date(),
          offset = hoy.getTimezoneOffset(),
          hoyLocal = new Date(hoy.getTime() - offset * 60 * 1000);
        document.getElementById("manualFechaHora").value = hoyLocal
          .toISOString()
          .slice(0, 16);
        selectMes.value = `${hoy.getFullYear()}-${String(
          hoy.getMonth() + 1
        ).padStart(2, "0")}`;
        
        getReport();
        loadUsers();
        poblarSelectorUsuarios("selectUsuario");
        poblarSelectorUsuarios("manualUsuario");
        poblarSelectorUsuarios("vacacionesUsuario");
        inicializarCalendario();
        poblarSelectorUsuarios("nominaUsuario");
        cargarNominasAdmin();
        document
          .getElementById("formSubirNomina")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData();
            formData.append("usuarioId", form.nominaUsuario.value);
            formData.append("mesAnio", form.nominaMesAnio.value);
            formData.append("nomina", form.nominaArchivo.files[0]);
            const btn = form.querySelector("button");
            btn.disabled = true;
            btn.textContent = "Subiendo...";
            try {
              const res = await fetch("/api/nominas", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.message);
              Swal.fire("¡Éxito!", data.message, "success");
              form.reset();
              cargarNominasAdmin();
            } catch (error) {
              Swal.fire(
                "Error",
                `No se pudo subir la nómina: ${error.message}`,
                "error"
              );
            } finally {
              btn.disabled = false;
              btn.textContent = "Subir Nómina";
            }
          });
        const fechaInicioInput = document.getElementById("fechaInicio"),
          fechaFinInput = document.getElementById("fechaFin");
        fechaInicioInput.addEventListener("change", () => {
          const fechaInicioSeleccionada = fechaInicioInput.value;
          if (fechaInicioSeleccionada) {
            fechaFinInput.min = fechaInicioSeleccionada;
            if (
              new Date(fechaFinInput.value) < new Date(fechaInicioSeleccionada)
            ) {
              fechaFinInput.value = fechaInicioSeleccionada;
            }
          }
        });

        // LÓGICA DE ACTUALIZACIÓN AUTOMÁTICA
        const REFRESH_INTERVAL_SECONDS = 30;
        let countdown = REFRESH_INTERVAL_SECONDS;
        const countdownElement = document.getElementById("countdown");
        
        // Inicializa el contador visual
        if (countdownElement) {
            countdownElement.textContent = countdown;
        }

        const refreshDynamicData = () => {
          console.log("Actualizando datos del panel...");
          cargarDashboard();
          cargarSolicitudesPendientes();
          cargarJustificantes();
        };
        refreshDynamicData();
        setInterval(() => {
          countdown--;
          if (countdownElement) {
            countdownElement.textContent = countdown;
          }
          if (countdown <= 0) {
            refreshDynamicData();
            countdown = REFRESH_INTERVAL_SECONDS;
            if (countdownElement) {
              countdownElement.textContent = countdown;
            }
          }
        }, 1000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const hamburgerBtn = document.getElementById("hamburger-btn");
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.querySelector(".overlay");
        function closeMenu() {
          sidebar.classList.remove("sidebar-visible");
          overlay.classList.remove("visible");
        }
        if (hamburgerBtn && sidebar && overlay) {
          hamburgerBtn.addEventListener("click", () => {
            sidebar.classList.toggle("sidebar-visible");
            overlay.classList.toggle("visible");
          });
          overlay.addEventListener("click", closeMenu);
          const navLinks = sidebar.querySelectorAll(".admin-nav a");
          navLinks.forEach((link) => {
            link.addEventListener("click", closeMenu);
          });
        }
      });

      inicializarPagina();

      const scrollTopBtn = document.getElementById("scrollTopBtn");
      window.onscroll = function () {
        if (
          document.body.scrollTop > 100 ||
          document.documentElement.scrollTop > 100
        ) {
          scrollTopBtn.classList.add("show");
        } else {
          scrollTopBtn.classList.remove("show");
        }
      };
      scrollTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "ServiceWorker registrado con éxito:",
                registration.scope
              );
            })
            .catch((err) => {
              console.log("El registro del ServiceWorker falló:", err);
            });
        });
      }
    </script>
  </body>
</html>