<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administrador</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
</head>
<body>
    <div class="container">
        <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        <h1>Panel de Administraci√≥n</h1>

        <nav class="admin-nav">
            <ul>
                <li><a href="#dashboard">Dashboard</a></li>
                <li><a href="#informe-diario">Informe Diario</a></li>
                <li><a href="#informe-mensual">Informe Mensual</a></li>
                <li><a href="#gestion-usuarios">Gesti√≥n Usuarios</a></li>
                <li><a href="#crear-usuario">Crear Usuario</a></li>
                <li><a href="#fichaje-manual">Fichaje Manual</a></li>
                <li><a href="#gestion-vacaciones">Gesti√≥n Vacaciones</a></li>
            </ul>
        </nav>

        <!-- ===================================== -->
        <!-- NUEVO: DASHBOARD DE ESTADO EN TIEMPO REAL -->
        <!-- ===================================== -->
        <section id="dashboard">
            <h2>Dashboard en Tiempo Real</h2>
            <div class="dashboard-grid">
                <!-- Widget: Qui√©n est√° dentro -->
                <div class="widget">
                    <h3><i class="bi bi-person-check-fill"></i> Empleados Fichados</h3>
                    <ul id="empleados-dentro" class="employee-list">
                        <li>Cargando...</li>
                    </ul>
                </div>

                <!-- Widget: Qui√©n est√° fuera -->
                <div class="widget">
                    <h3><i class="bi bi-person-x-fill"></i> Empleados Fuera</h3>
                    <ul id="empleados-fuera" class="employee-list">
                        <li>Cargando...</li>
                    </ul>
                </div>

                <!-- Widget: Ausencias del d√≠a -->
                <div class="widget">
                    <h3><i class="bi bi-calendar-x"></i> Ausencias Hoy</h3>
                    <ul id="ausencias-hoy" class="employee-list">
                        <li>Cargando...</li>
                    </ul>
                </div>

                <!-- Widget: Resumen de Fichajes -->
                <div class="widget">
                    <h3><i class="bi bi-card-list"></i> Resumen del D√≠a</h3>
                    <p id="total-fichajes"><strong>Total de fichajes hoy:</strong> <span>Cargando...</span></p>
                    <p id="fichajes-manuales"><strong>Fichajes manuales/editados:</strong> <span>Cargando...</span></p>
                </div>
            </div>
        </section>
        <hr />

        <section id="informe-diario">
            <h2>Informe de Asistencia Diario</h2>
            <input type="date" id="fecha" onchange="getReport()" />
            <div class="table-container">
                <table id="reportTable">
                    <thead><tr><th>Nombre</th><th>Fecha y Hora</th><th>Tipo</th><th>Foto</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <hr />

        <section id="informe-mensual">
            <h2>Informe Mensual por Trabajador</h2>
            <div>
                <select id="selectUsuario" required>
                    <option value="">-- Selecciona un trabajador --</option>
                </select>
                <input type="month" id="selectMes" required />
                <button onclick="generarInformeMensual()">Generar Informe</button>
                <button id="btnExportar" style="display: none" onclick="exportarCSV()">Exportar a CSV</button>
            </div>
            <div id="informeMensualContainer" style="margin-top: 20px;"></div>
        </section>
        <hr />

        <section id="gestion-usuarios">
            <h2>Gesti√≥n de Usuarios</h2>
            <div class="table-container">
                <table id="usersTable">
                    <thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
        <hr />

        <section id="crear-usuario">
            <h2>Crear Nuevo Usuario</h2>
            <form id="createUserForm">
                <input type="text" id="nombre" placeholder="Nombre completo" required />
                <input type="text" id="usuario" placeholder="Nombre de usuario (login)" required />
                <input type="password" id="password" placeholder="Contrase√±a" required />
                <select id="rol" required>
                    <option value="empleado" selected>Empleado</option>
                    <option value="admin">Administrador</option>
                    <option value="gestor_vacaciones">Gestor de Vacaciones</option>
                </select>
                <button type="submit" class="btn-create">Crear Usuario</button>
            </form>
        </section>
        <hr />
        
        <section id="fichaje-manual">
            <h2>Crear Fichaje Manual</h2>
            <form id="manualAttendanceForm">
                <label for="manualUsuario">Trabajador:</label>
                <select id="manualUsuario" required>
                    <option value="">-- Selecciona un trabajador --</option>
                </select>
                <label for="manualFechaHora">Fecha y Hora del Fichaje:</label>
                <input type="datetime-local" id="manualFechaHora" required />
                <label for="manualTipo">Tipo de Fichaje:</label>
                <select id="manualTipo" required>
                    <option value="" disabled selected>-- Selecciona tipo --</option>
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                </select>
                <label for="manualMotivo">Motivo (ej: olvido, error del sistema):</label>
                <textarea id="manualMotivo" placeholder="Es obligatorio explicar por qu√© se crea este fichaje." required></textarea>
                <button type="submit">Crear Fichaje Manual</button>
            </form>
        </section>
        <hr />

        <section id="gestion-vacaciones">
            <h2>Gesti√≥n de Vacaciones</h2>
            <form id="formVacaciones">
                <label for="vacacionesUsuario">Trabajador:</label>
                <select id="vacacionesUsuario" required>
                    <option value="">-- Selecciona un trabajador --</option>
                </select>
                <span id="infoDiasRestantes" style="display: block; margin-bottom: 15px; font-weight: bold;"></span>
                
                <label for="fechaInicio">Fecha de Inicio:</label>
                <input type="date" id="fechaInicio" required>
                
                <label for="fechaFin">Fecha de Fin:</label>
                <input type="date" id="fechaFin" required>
                
                <button type="submit">Asignar Vacaciones</button>
            </form>
            <hr style="margin: 20px 0;">
            <div id="calendarioVacaciones"></div>
        </section>
    </div>

    <button id="scrollTopBtn" title="Volver arriba">‚áß</button>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "/index.html";
        const selectUsuario = document.getElementById('selectUsuario');
        const selectMes = document.getElementById('selectMes');
        const btnExportar = document.getElementById('btnExportar');
        let calendario;
        
        function logout() {
            localStorage.removeItem("token");
            window.location.href = "/index.html";
        }

        // ===================================================
        // NUEVO: L√ìGICA PARA CARGAR EL DASHBOARD
        // ===================================================
        async function cargarDashboard() {
            const ids = {
                dentro: document.getElementById('empleados-dentro'),
                fuera: document.getElementById('empleados-fuera'),
                ausencias: document.getElementById('ausencias-hoy'),
                total: document.querySelector('#total-fichajes span'),
                manuales: document.querySelector('#fichajes-manuales span')
            };

            try {
                const res = await fetch('/api/dashboard', { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) throw new Error('No se pudo cargar el dashboard.');
                const data = await res.json();
                
                // Funci√≥n auxiliar para rellenar listas
                const rellenarLista = (ulElement, items) => {
                    ulElement.innerHTML = ''; // Limpiar "Cargando..."
                    if (items.length === 0) {
                        ulElement.innerHTML = '<li></li>'; // Para que muestre el mensaje de "No hay datos" del CSS
                    } else {
                        items.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item;
                            ulElement.appendChild(li);
                        });
                    }
                };

                // Rellenar widgets
                rellenarLista(ids.dentro, data.empleadosDentro);
                rellenarLista(ids.fuera, data.empleadosFuera);
                rellenarLista(ids.ausencias, data.ausenciasHoy);
                
                ids.total.textContent = data.resumen.totalFichajes;
                ids.manuales.textContent = data.resumen.fichajesManuales;

            } catch (error) {
                console.error('Error en cargarDashboard:', error);
                // Mostrar mensaje de error en los widgets
                Object.values(ids).forEach(el => {
                    if (el.tagName === 'UL') el.innerHTML = '<li>Error al cargar</li>';
                    else if (el.tagName === 'SPAN') el.textContent = 'Error';
                });
            }
        }

        async function getReport() {
            const fecha = document.getElementById("fecha").value;
            if (!fecha) return;
            try {
                const res = await fetch(`/api/informe?fecha=${fecha}`, { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) throw new Error('Error al cargar informe diario');
                const data = await res.json();
                const tbody = document.querySelector("#reportTable tbody");
                tbody.innerHTML = "";
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No hay registros para esta fecha.</td></tr>';
                } else {
                    data.forEach(row => {
                        const tr = document.createElement("tr");
                        const fechaHora = new Date(row.fecha_hora).toLocaleString("es-ES", { dateStyle: "short", timeStyle: "medium" });
                        const fotoHtml = row.foto_path ? `<a href="${row.foto_path}" target="_blank"><img src="${row.foto_path}" alt="Foto fichaje" class="photo-thumbnail"></a>` : "Sin foto";
                        let indicadorEditado = '';
                        if (row.es_modificado) {
                            const fechaOriginal = row.fecha_hora_original ? new Date(row.fecha_hora_original).toLocaleString("es-ES") : 'N/A';
                            const motivo = row.motivo_modificacion ? row.motivo_modificacion.replace(/"/g, '"') : 'N/A';
                            const title = row.fecha_hora_original ? `Editado. Original: ${fechaOriginal}. Motivo: ${motivo}` : `Registro manual. Motivo: ${motivo}`;
                            indicadorEditado = `<span title="${title}" style="cursor: help; color: #f39c12; font-weight: bold;"> ‚úèÔ∏è</span>`;
                        }
                        tr.innerHTML = `<td>${row.nombre}</td><td>${fechaHora}${indicadorEditado}</td><td>${row.tipo}</td><td>${fotoHtml}</td><td><button class="action-btn btn-reset" onclick="abrirModalEdicion(${row.id}, '${row.fecha_hora}', '${row.nombre}')">Editar</button><button class="action-btn btn-delete" onclick="eliminarRegistro(${row.id}, '${row.nombre}', '${fechaHora}')">Eliminar</button></td>`;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) { document.querySelector("#reportTable tbody").innerHTML = '<tr><td colspan="5">Error al cargar datos.</td></tr>'; }
        }

        async function abrirModalEdicion(registroId, fechaHoraActual, nombreUsuario) {
            const fechaParaInput = new Date(fechaHoraActual).toISOString().slice(0, 16);
            const { value: formValues } = await Swal.fire({
                title: `Editar fichaje de ${nombreUsuario}`,
                html: `<p style="margin-bottom: 1rem;">Fecha y Hora Actual: ${new Date(fechaHoraActual).toLocaleString()}</p><label for="swal-input-fecha">Nueva Fecha y Hora:</label><input id="swal-input-fecha" type="datetime-local" value="${fechaParaInput}" class="swal2-input" style="width: auto; margin-top: 0.5rem;"><textarea id="swal-input-motivo" class="swal2-textarea" placeholder="Motivo de la edici√≥n (obligatorio)" style="margin-top: 1rem;"></textarea>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'Guardar Cambios', cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const nuevaFechaHora = document.getElementById('swal-input-fecha').value;
                    const motivo = document.getElementById('swal-input-motivo').value.trim();
                    if (!nuevaFechaHora || !motivo) { Swal.showValidationMessage('Por favor, completa la nueva fecha/hora y el motivo.'); return false; }
                    return { nuevaFechaHora, motivo };
                }
            });
            if (formValues) {
                try {
                    const res = await fetch(`/api/registros/${registroId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(formValues) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¬°Actualizado!', 'El registro ha sido modificado con √©xito.', 'success');
                    getReport();
                } catch (error) { Swal.fire('Error', `No se pudo actualizar: ${error.message}`, 'error'); }
            }
        }

        async function eliminarRegistro(registroId, nombreUsuario, fechaHoraFormateada) {
            Swal.fire({
                title: `¬øEst√°s seguro?`, html: `Se eliminar√° permanentemente el fichaje de <strong>${nombreUsuario}</strong> de la fecha <strong>${fechaHoraFormateada}</strong>. <br><br><strong>¬°Esta acci√≥n no se puede revertir!</strong>`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'S√≠, ¬°eliminar!', cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`/api/registros/${registroId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.message);
                        Swal.fire('¬°Eliminado!', 'El registro ha sido eliminado.', 'success');
                        getReport();
                    } catch (error) { Swal.fire('Error', `No se pudo eliminar: ${error.message}`, 'error'); }
                }
            });
        }

        async function loadUsers() {
            try {
                const res = await fetch("/api/usuarios", { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) throw new Error("No se pudo cargar la lista de usuarios.");
                const users = await res.json();
                const tbody = document.querySelector("#usersTable tbody");
                tbody.innerHTML = "";
                users.forEach(user => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${user.nombre}</td><td>${user.usuario}</td><td>${user.rol}</td><td><button class="action-btn btn-reset" onclick="resetPassword(${user.id}, '${user.nombre}')">Resetear</button><button class="action-btn btn-delete" onclick="deleteUser(${user.id}, '${user.nombre}')">Eliminar</button></td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) { console.error("Error en loadUsers:", error); }
        }

        async function resetPassword(userId, userName) {
            const { value: newPassword } = await Swal.fire({
                title: `Nueva contrase√±a para ${userName}`, input: 'password', inputLabel: 'Contrase√±a', inputPlaceholder: 'Introduce la nueva contrase√±a',
                showCancelButton: true, confirmButtonText: 'Restablecer', cancelButtonText: 'Cancelar',
                inputValidator: (value) => !value && '¬°Necesitas escribir una contrase√±a!'
            });
            if (newPassword) {
                try {
                    const res = await fetch(`/api/usuarios/${userId}/password`, { method: "PUT", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify({ password: newPassword }) });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¬°√âxito!', data.message, 'success');
                } catch (error) { Swal.fire('Error', error.message, 'error'); }
            }
        }

        async function deleteUser(userId, userName) {
            Swal.fire({
                title: `¬øEst√°s seguro de eliminar a ${userName}?`, text: "¬°Esta acci√≥n no se puede revertir!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'S√≠, ¬°eliminar!', cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`/api/usuarios/${userId}`, { method: "DELETE", headers: { Authorization: `Bearer ${token}` } });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.message);
                        Swal.fire('¬°Eliminado!', 'El usuario ha sido eliminado.', 'success');
                        loadUsers();
                        poblarSelectorUsuarios('selectUsuario');
                        poblarSelectorUsuarios('manualUsuario');
                        poblarSelectorUsuarios('vacacionesUsuario');
                    } catch (error) { Swal.fire('Error', error.message, 'error'); }
                }
            });
        }

        async function poblarSelectorUsuarios(selectorId) {
            const selectElement = document.getElementById(selectorId);
            try {
                const res = await fetch('/api/usuarios', { headers: { 'Authorization': `Bearer ${token}` } });
                const usuarios = await res.json();
                const defaultOptionHTML = selectElement.querySelector('option[value=""]').outerHTML;
                selectElement.innerHTML = defaultOptionHTML;
                usuarios.forEach(user => {
                    if (user.rol === 'empleado') {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.nombre;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) { console.error(`Error en poblarSelectorUsuarios para #${selectorId}:`, error); }
        }

        async function generarInformeMensual() {
            const usuarioId = selectUsuario.value;
            const mesValue = selectMes.value;
            if (!usuarioId) { Swal.fire('Atenci√≥n', 'Selecciona un trabajador.', 'info'); return; }
            if (!mesValue) { Swal.fire('Atenci√≥n', 'Selecciona un mes.', 'info'); return; }
            const [anio, mes] = mesValue.split('-');
            const container = document.getElementById('informeMensualContainer');
            container.innerHTML = 'Generando informe...';
            btnExportar.style.display = 'none';
            try {
                const url = `/api/informe-mensual?anio=${anio}&mes=${mes}&usuarioId=${usuarioId}`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) { const errData = await res.json().catch(() => ({ message: `Error: ${res.status}` })); throw new Error(errData.message); }
                const informe = await res.json();
                const segundosAFormatoHora = (s) => new Date((s || 0) * 1000).toISOString().substr(11, 8);
                let html = `<h3>Informe para ${selectUsuario.options[selectUsuario.selectedIndex].text}</h3>`;
                if (Object.keys(informe.resumenSemanas).length === 0) {
                     html += '<p>No hay datos de trabajo para el mes seleccionado.</p>';
                     container.innerHTML = html;
                     return;
                }
                html += '<h4>Resumen Semanal:</h4><ul>';
                for (const numSemana in informe.resumenSemanas) {
                    const semana = informe.resumenSemanas[numSemana];
                    html += `<li><strong>Semana ${numSemana}:</strong><ul><li>Horas Trabajadas: ${segundosAFormatoHora(semana.totalSegundos)}</li><li>Horas Extra (sobre 40h/sem): ${segundosAFormatoHora(semana.horasExtraSegundos)}</li></ul></li>`;
                }
                html += '</ul><hr style="margin: 20px 0;">';
                html += `<p><strong>Total Horas en el Mes:</strong> ${segundosAFormatoHora(informe.totalHorasMesSegundos)}</p>`;
                html += `<p><strong>Total Horas Extra en el Mes:</strong> ${segundosAFormatoHora(informe.totalHorasExtraMesSegundos)}</p>`;
                container.innerHTML = html;
                if (informe.totalHorasMesSegundos > 0) btnExportar.style.display = 'inline-block';
            } catch (error) {
                Swal.fire('Error', `No se pudo generar el informe: ${error.message}`, 'error');
                container.innerHTML = '';
            }
        }

        async function exportarCSV() {
            const usuarioId = selectUsuario.value;
            const [anio, mes] = selectMes.value.split('-');
            if (!usuarioId) return;
            btnExportar.textContent = 'Exportando...';
            btnExportar.disabled = true;
            try {
                const url = `/api/exportar-csv?anio=${anio}&mes=${mes}&usuarioId=${usuarioId}`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) { const errorData = await res.json().catch(() => ({ message: `Error: ${res.status}` })); throw new Error(errorData.message); }
                const blob = await res.blob();
                const contentDisposition = res.headers.get('content-disposition');
                let fileName = `informe-${anio}-${mes}.csv`;
                if (contentDisposition) { const fileNameMatch = contentDisposition.match(/filename="(.+)"/); if (fileNameMatch.length === 2) fileName = fileNameMatch[1]; }
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(link.href);
            } catch (error) { Swal.fire('Error', `No se pudo exportar: ${error.message}`, 'error'); } 
            finally { btnExportar.textContent = 'Exportar a CSV'; btnExportar.disabled = false; }
        }
        
        document.getElementById("createUserForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const [nombre, usuario, password, rol] = [e.target.nombre.value, e.target.usuario.value, e.target.password.value, e.target.rol.value];
            try {
                const res = await fetch("/api/usuarios", { method: "POST", headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }, body: JSON.stringify({ nombre, usuario, password, rol }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                Swal.fire({ title: '¬°Usuario Creado!', text: data.message, icon: 'success', timer: 2000, showConfirmButton: false });
                e.target.reset();
                loadUsers();
                poblarSelectorUsuarios('selectUsuario');
                poblarSelectorUsuarios('manualUsuario');
                poblarSelectorUsuarios('vacacionesUsuario');
            } catch (error) { Swal.fire('Error', error.message, 'error'); }
        });

        document.getElementById("manualAttendanceForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const usuarioId = document.getElementById('manualUsuario').value;
            const fechaHora = document.getElementById('manualFechaHora').value;
            const tipo = document.getElementById('manualTipo').value;
            const motivo = document.getElementById('manualMotivo').value;
            if (!usuarioId || !fechaHora || !tipo || !motivo) { Swal.fire('Error', 'Completa todos los campos.', 'error'); return; }
            try {
                const res = await fetch('/api/fichaje-manual', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ usuarioId, fechaHora, tipo, motivo }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                Swal.fire({ title: '¬°√âxito!', text: data.message, icon: 'success', timer: 2000, showConfirmButton: false });
                e.target.reset();
                getReport();
            } catch (error) { Swal.fire('Error', `No se pudo crear el fichaje: ${error.message}`, 'error'); }
        });
        
        // ==================================================
        // L√ìGICA PARA GESTI√ìN DE VACACIONES
        // ==================================================
        function inicializarCalendario() {
            const calendarioEl = document.getElementById('calendarioVacaciones');
            calendario = new FullCalendar.Calendar(calendarioEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                eventClick: function(info) {
                    handleEventClick(info.event);
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    fetch('/api/vacaciones', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    })
                    .then(res => res.ok ? res.json() : Promise.reject('Respuesta no v√°lida del servidor'))
                    .then(data => {
                        const dataProcesada = data.map(evento => {
                            let solapado = false;
                            const inicioEvento = new Date(evento.fecha_inicio);
                            const finEvento = new Date(evento.fecha_fin);
                            for (const otroEvento of data) {
                                if (evento.id === otroEvento.id) continue;
                                const inicioOtro = new Date(otroEvento.fecha_inicio);
                                const finOtro = new Date(otroEvento.fecha_fin);
                                if (inicioEvento <= finOtro && finEvento >= inicioOtro) {
                                    solapado = true;
                                    break;
                                }
                            }
                            return { ...evento, backgroundColor: solapado ? '#e74c3c' : '#3498db', borderColor: solapado ? '#c0392b' : '#2980b9' };
                        });
                        const eventosFinales = dataProcesada.map(evento => ({
                            id: evento.id, title: evento.nombre, start: evento.fecha_inicio,
                            end: new Date(new Date(evento.fecha_fin).getTime() + 86400000).toISOString().split('T')[0],
                            backgroundColor: evento.backgroundColor, borderColor: evento.borderColor
                        }));
                        successCallback(eventosFinales);
                    })
                    .catch(error => {
                        failureCallback(error);
                        Swal.fire('Error', 'No se pudieron cargar las vacaciones en el calendario.', 'error');
                    });
                }
            });
            calendario.render();
        }

        async function handleEventClick(event) {
            const { value: action } = await Swal.fire({
                title: `Gestionar vacaciones de ${event.title}`,
                text: `Del ${new Date(event.start).toLocaleDateString()} al ${new Date(new Date(event.end).getTime() - 86400000).toLocaleDateString()}`,
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: '‚úèÔ∏è Editar',
                denyButtonText: `üóëÔ∏è Eliminar`,
                cancelButtonText: 'Cancelar'
            });

            if (action === true) {
                handleEditVacation(event);
            } else if (action === false) {
                handleDeleteVacation(event);
            }
        }

        async function handleEditVacation(event) {
            const fechaInicioActual = new Date(event.start).toISOString().split('T')[0];
            const fechaFinActual = new Date(new Date(event.end).getTime() - 86400000).toISOString().split('T')[0];
            const { value: formValues } = await Swal.fire({
                title: `Editar vacaciones de ${event.title}`,
                html: `
                    <label for="swal-fecha-inicio" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Inicio:</label>
                    <input id="swal-fecha-inicio" type="date" class="swal2-input" value="${fechaInicioActual}">
                    <label for="swal-fecha-fin" style="display: block; text-align: left; margin-top: 1rem;">Fecha de Fin:</label>
                    <input id="swal-fecha-fin" type="date" class="swal2-input" value="${fechaFinActual}">`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Guardar Cambios',
                preConfirm: () => ({
                    fechaInicio: document.getElementById('swal-fecha-inicio').value,
                    fechaFin: document.getElementById('swal-fecha-fin').value
                })
            });

            if (formValues) {
                try {
                    const res = await fetch(`/api/vacaciones/${event.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(formValues)
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¬°Actualizado!', data.message, 'success');
                    calendario.refetchEvents();
                    mostrarDiasRestantes();
                } catch (error) {
                    Swal.fire('Error', `No se pudo actualizar: ${error.message}`, 'error');
                }
            }
        }

        async function handleDeleteVacation(event) {
            const result = await Swal.fire({
                title: '¬øEst√°s seguro?',
                text: `Se eliminar√°n las vacaciones de ${event.title}. ¬°Esta acci√≥n no se puede revertir!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, ¬°eliminar!',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/vacaciones/${event.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    Swal.fire('¬°Eliminado!', data.message, 'success');
                    calendario.refetchEvents();
                    mostrarDiasRestantes();
                } catch (error) {
                    Swal.fire('Error', `No se pudo eliminar: ${error.message}`, 'error');
                }
            }
        }

        async function mostrarDiasRestantes() {
            const usuarioId = document.getElementById('vacacionesUsuario').value;
            const infoSpan = document.getElementById('infoDiasRestantes');
            if (!usuarioId) { infoSpan.textContent = ''; return; }
            try {
                const res = await fetch(`/api/usuarios/${usuarioId}/vacaciones-restantes`, { headers: { Authorization: `Bearer ${token}` } });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                infoSpan.innerHTML = `Disponibles: <span style="color: green;">${data.diasRestantes}</span> / ${data.diasTotales} (Gastados: ${data.diasGastados})`;
            } catch (error) { infoSpan.textContent = 'Error al calcular d√≠as.'; infoSpan.style.color = 'red'; }
        }
        
        document.getElementById('vacacionesUsuario').addEventListener('change', mostrarDiasRestantes);

        document.getElementById('formVacaciones').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usuarioId = document.getElementById('vacacionesUsuario').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            try {
                const res = await fetch('/api/vacaciones', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ usuarioId, fechaInicio, fechaFin }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message);
                Swal.fire('¬°√âxito!', 'Vacaciones asignadas.', 'success');
                e.target.reset();
                document.getElementById('infoDiasRestantes').textContent = '';
                calendario.refetchEvents();
            } catch (error) { Swal.fire('Error', `No se pudo asignar: ${error.message}`, 'error'); }
        });
        
        function inicializarPagina() {
            document.getElementById("fecha").valueAsDate = new Date();
            const hoy = new Date(), offset = hoy.getTimezoneOffset(), hoyLocal = new Date(hoy.getTime() - (offset*60*1000));
            document.getElementById('manualFechaHora').value = hoyLocal.toISOString().slice(0, 16);
            selectMes.value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
            
            cargarDashboard(); // Cargar el nuevo dashboard
            getReport();
            loadUsers();
            poblarSelectorUsuarios('selectUsuario');
            poblarSelectorUsuarios('manualUsuario');
            poblarSelectorUsuarios('vacacionesUsuario');
            inicializarCalendario();

            const fechaInicioInput = document.getElementById('fechaInicio'), fechaFinInput = document.getElementById('fechaFin');
            fechaInicioInput.addEventListener('change', () => {
                const fechaInicioSeleccionada = fechaInicioInput.value;
                if (fechaInicioSeleccionada) {
                    fechaFinInput.value = fechaInicioSeleccionada;
                    fechaFinInput.min = fechaInicioSeleccionada;
                }
            });
        }

        inicializarPagina();

        // L√≥gica para el bot√≥n "Volver arriba"
        const scrollTopBtn = document.getElementById("scrollTopBtn");
        window.onscroll = function() {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollTopBtn.classList.add("show");
            } else {
                scrollTopBtn.classList.remove("show");
            }
        };
        scrollTopBtn.addEventListener("click", () => {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    </script>
</body>
</html>